<%--
  Created by IntelliJ IDEA.
  User: Persist
  Date: 2018/7/3
  Time: 11:41
  To change this template use File | Settings | File Templates.
--%>
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<%@ include file="../../../public/tag.jsp" %>
<html>
<head>
    <title>开放试题</title>
    <link rel="stylesheet" href="${baseurl}/public/common/layui/css/layui.css" media="all">
    <link rel="stylesheet" type="text/css" href="${baseurl}/public/common/layui/css/layui.css" media="all">
    <link rel="stylesheet" type="text/css" href="${baseurl}/public/common/bootstrap/css/bootstrap.min.css" media="all">
    <link rel="stylesheet" type="text/css" href="${baseurl}/public/common/css/global.css" media="all">
    <link rel="stylesheet" type="text/css" href="${baseurl}/public/css/common.css" media="all">
    <link rel="stylesheet" type="text/css" href="${baseurl}/public/css/personal.css" media="all">
    <script type="text/javascript" src="${baseurl}/public/common/js/jquery-3.2.0.min.js"></script>
    <script src="${baseurl}/public/common/layui/layui.js" charset="utf-8"></script>
</head>
<body>
<div class="layui-form" style="width: 98%;margin-left: 1%" id="questions">

</div>
<div id="view" style="display: none;width: 90%;margin-left: 5%;margin-bottom: 50px">

</div>

<div id="watchadd" style="display: none;width: 90%;margin-left: 5%;margin-bottom: 50px">

</div>
<script src="${baseurl}/public/js/layui/layui.js" charset="utf-8"></script>
<script>
    let _open;
    let _operating;
    //动态拼接测试题信息
    $(function () {

        layui.use(['jquery', 'layer', 'element', 'laypage', 'form', 'laytpl', 'tree', 'layedit'], function () {
            window.jQuery = window.$ = layui.jquery;
            window.layer = layui.layer;

            var element = layui.element(),
                form = layui.form(),
                layedit = layui.layedit,
                laytpl = layui.laytpl;

        });
        _open = {
            initialize: function () {
                var _html = "";
                _html += (`
                    <table class="layui-table">
                    <colgroup>
                    <col width="200">
                    <col width="200">
                    <col width="200">
                    <col width="200">
                    <col width="200">
                    <col>
                    </colgroup>
                    <thead>
                    <tr>
                    <th style="text-align: center">开放试题题目</th>
                    <th style="text-align: center">试题个数</th>
                    <th style="text-align: center">出题教师</th>
                    <th style="text-align: center">作答正确个数</th>
                    <th style="text-align: center">操作</th>
                    </tr>
                    </thead>`);
                $.post("${baseurl}/Testpaper/findOpenTest", function (data) {
                    console.log(data.data);
                    for (let i = 0; i < data.data.length; i++) {
                        let number = "未答题";
                        if (data.data[i].trueNum != null) {
                            number = data.data[i].trueNum
                        }
                        _html += (`<tbody>
                    <tr>
                    <td style="text-align: center">` + data.data[i].name + `</td>
                    <td style="text-align: center">` + data.data[i].num + `</td>
                    <td style="text-align: center">` + data.data[i].teacherName + `</td>
                    <td style="text-align: center"> ` + number + `</td>
                    <td style="text-align: center">
                    <a class="layui-btn  layui-btn-small layui-btn-normal " onclick="_operating.answer(` + data.data[i].id + `,'` + data.data[i].subject_id + `')">
                            <i class="layui-icon">&#xe642;</i>答题</a>
                    <a class="layui-btn  layui-btn-small" onclick="_operating.preview(` + data.data[i].id + `,'` + data.data[i].subject_id + `')">
                            <i class="layui-icon">&#xe60a;</i>预览</a>
                            </td>
                    </tr>
                </tbody>`);
                    }
                    _html += (`</table>`);
                    $("#questions").html(_html);
                });

            }
        };
        $(function () {
            _open.initialize();
        })
    });
    _operating = {
        answer: function (id, subject_id) {
            $.post("${baseurl}/Testpaper/findOpenTestById", {subject_id: subject_id}, function (data) {
                ID = id;
                testQuestions = data;
                var _html = "";
                for (var i = 0; i < data.data.length; i++) {
                    _html += (`<fieldset class="layui-elem-field site-demo-button checkboxAll" style="margin-top: 30px;">
                                <legend>试题` + (i + 1) + `：</legend>
                                <div class="layui-field-box">
                                    <b>题目：</b>
                                    <p>` + data.data[i].subject + `</p>
                                </div>`);
                    if (data.data[i].subject_img !== undefined) {
                        _html += (`<b style="margin-left: 12px">题目图片</b>
                                                    <div class="layui-field-box box">
                                    <img width="300px" height="300px" src="` + data.data[i].subject_img + `"/><br>
                                </div>`)
                    }
                    _html += (`<div class="layui-field-box">
                                    <label><input type="radio" style="width: 10px;height: 10px;" name="` + data.data[i].id + `" value="A" class="checkboxA"> <b>选项A：</b></label>` + data.data[i].option_a + `
                                </div>
                                <div class="layui-field-box">

                                    <label><input type="radio" style="width: 10px;height: 10px;" name="` + data.data[i].id + `"  value="B" class="checkboxB"> <b>选项B：</b></label>` + data.data[i].option_b + `
                                </div>
                                <div class="layui-field-box">

                                    <label><input type="radio" style="width: 10px;height: 10px;" name="` + data.data[i].id + `"  value="C" class="checkboxC"><b>选项C：</b></label>` + data.data[i].option_c + `
                                </div>
                                <div class="layui-field-box">

                                    <label><b><input type="radio" style="width: 10px;height: 10px;" name="` + data.data[i].id + `"  value="D" class="checkboxD">选项D：</b></label>` + data.data[i].option_d + `
                                </div>`)

                    if (data.data[i].subject_e === undefined) {

                        _html += (`<div class="layui-field-box">

                                    <label><b><input type="radio" style="width: 10px;height: 10px;" name="` + data.data[i].id + `"  value="E" class="checkboxD">选项E：</b></label>` + data.data[i].option_e + `
                                </div>`)
                    }
                    _html += (`</fieldset>`);
                }
                _html += `<input type="button" style="margin-left: 50%;margin-bottom: 25px;margin-top: 10px" value="交卷" class="layui-btn layui-btn-radius" id="crop" onclick=" _operating.assignment(`+ID+`)">`
                $("#view").html(_html);
            });
            layer.open({
                type: 1,
                title: "在线答题",
                area: ["100%", "100%"],
                skin: 'yourclass',
                content: $('#view')
            });
        },
        preview: function (id, subject_id) {
            $.post("${baseurl}/Testpaper/findOpenTestById", {subject_id: subject_id}, function (data) {
                var _html = "";
                for (var i = 0; i < data.data.length; i++) {
                    _html += (`<fieldset class="layui-elem-field site-demo-button checkboxAll" style="margin-top: 30px;">
                                <legend>试题` + (i + 1) + `：</legend>
                                <div class="layui-field-box">
                                    <b>题目：</b>
                                    <p>` + data.data[i].subject + `</p>
                                </div>`);
                    if (data.data[i].subject_img !== undefined) {
                        _html += (`<b style="margin-left: 12px">题目图片</b>
                                                    <div class="layui-field-box box">
                                    <img width="300px" height="300px" src="` + data.data[i].subject_img + `"/><br>
                                </div>`)
                    }
                    _html += (`<div class="layui-field-box">
                                    <label><b>选项A：</b></label>` + data.data[i].option_a + `
                                </div>
                                <div class="layui-field-box">

                                    <label><b>选项B：</b></label>` + data.data[i].option_b + `
                                </div>
                                <div class="layui-field-box">

                                    <label><b>选项C：</b></label>` + data.data[i].option_c + `
                                </div>
                                <div class="layui-field-box">

                                    <label><b>选项D：</b></label>` + data.data[i].option_d + `
                                </div>`)

                    if (data.data[i].subject_e === undefined) {

                        _html += (`<div class="layui-field-box">

                                    <label><b>选项E：</b></label>` + data.data[i].option_e + `
                                </div>`)
                    }
                    _html += (`<hr>
                                <div class="layui-field-box">
                                    <label><b>正确答案：</b></label>` + data.data[i].correct + `
                                </div>
                                </fieldset>`);
                }
                $("#watchadd").html(_html);
            });
            layer.open({
                type: 1,
                title: "试题预览",
                area: ["100%", "100%"],
                skin: 'yourclass',
                content: $('#watchadd')
            });
        },
        assignment:function (ID) {
            alert(ID)
            document.getElementById("crop").setAttribute("disabled", true);
            let score = 0;  //未答题前成绩为0
            let checkBoxs = []; //自定义选项的数组
            let trueNum = 0;
            for (var i = 0; i < testQuestions.data.length; i++) {
                checkBoxs.push($("input[name='" + testQuestions.data[i].id + "']:checked").val());
                if (testQuestions.data[i].correct == checkBoxs[i]) {
                    trueNum++;
                }
            }
            alert(trueNum)
            //存储答题情况
            $.post("${baseurl}/Testpaper/insertOpenTestGrade", {ID : ID,trueNum:trueNum}, function (data) {
                if (data.result) {
                    layer.msg(data.msg);
                    setTimeout("location.reload()", 500);
                }
            });
        }
    }
</script>
</body>
</html>
